<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PICO9918 Configuration Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --secondary-color: #6b7280;
            --background: #1a1a1a;
            --card-background: #2a2a2a;
            --border-color: #404040;
            --text-primary: #e5e5e5;
            --text-secondary: #a0a0a0;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding-bottom: 100px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: var(--card-background);
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        h1 {
            color: var(--primary-color);
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .links {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .links a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }

        .links a:hover {
            text-decoration: underline;
        }

        .card {
            background: var(--card-background);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .card h2 {
            color: var(--text-primary);
            font-size: 1.5em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .collapsible {
            cursor: pointer;
            user-select: none;
        }

        .collapsible::before {
            content: '▼';
            display: inline-block;
            transition: transform 0.3s;
            font-size: 0.8em;
        }

        .collapsible.collapsed::before {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .radio-group, .checkbox-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .radio-option, .checkbox-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="radio"], input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        select {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 1em;
            background: var(--card-background);
            color: var(--text-primary);
            cursor: pointer;
            transition: border-color 0.2s;
        }

        select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        select option {
            background: var(--card-background);
            color: var(--text-primary);
        }

        .palette-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 12px;
            margin-top: 20px;
            max-width: 750px;
        }

        .color-picker-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--card-background);
        }

        .color-picker-item.disabled {
            opacity: 0.6;
            background: var(--background);
        }

        .color-picker-item label {
            font-weight: 500;
            margin-bottom: 0;
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        input[type="color"] {
            width: 60px;
            height: 60px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
        }

        input[type="color"]:disabled {
            cursor: not-allowed;
        }

        .color-value {
            font-family: monospace;
            font-size: 0.75em;
            color: var(--text-secondary);
            text-align: center;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .info-box {
            background: #1e3a5f;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin-top: 15px;
            border-radius: 4px;
            color: #e5e5e5;
        }

        .warning-box {
            background: #3d2e1a;
            border-left: 4px solid var(--warning-color);
            padding: 15px;
            margin-top: 15px;
            border-radius: 4px;
            color: #e5e5e5;
        }

        .summary {
            background: #1f1f1f;
            padding: 20px;
            border-radius: 6px;
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }

        .summary h3 {
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .summary-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .sticky-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-background);
            border-top: 2px solid var(--border-color);
            padding: 20px;
            box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .footer-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }

            .palette-grid {
                grid-template-columns: repeat(4, 1fr);
                max-width: 100%;
            }

            .footer-content {
                flex-direction: column;
            }

            button {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .palette-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>PICO9918 Configuration Generator</h1>
            <p class="subtitle">Generate custom configuration UF2 files for your PICO9918</p>
            <div class="links">
                <a href="https://github.com/visrealm/pico9918" target="_blank">GitHub Repository</a>
                <a href="https://github.com/visrealm/pico9918/releases" target="_blank">Firmware Releases</a>
                <a href="https://atariage.com/forums/topic/323020-pico9918-drop-in-replacement-for-tms9918a" target="_blank">AtariAge Forum</a>
            </div>
        </header>

        <!-- Display Settings -->
        <div class="card">
            <h2>Display Settings</h2>
            <div class="form-group">
                <div class="checkbox-option">
                    <input type="checkbox" id="scanlines" name="scanlines">
                    <label for="scanlines">Enable CRT Scanlines</label>
                </div>
            </div>
            <div class="form-group">
                <label for="scanlineSprites">Scanline Sprite Limit</label>
                <select id="scanlineSprites" name="scanlineSprites">
                    <option value="0" selected>4 sprites per scanline</option>
                    <option value="1">8 sprites per scanline</option>
                    <option value="2">16 sprites per scanline</option>
                    <option value="3">32 sprites per scanline</option>
                </select>
            </div>
            <div class="form-group">
                <label for="clockPreset">Clock Frequency</label>
                <select id="clockPreset" name="clockPreset">
                    <option value="0" selected>252.0 MHz (Default)</option>
                    <option value="1">302.4 MHz</option>
                    <option value="2">352.0 MHz</option>
                </select>
            </div>
        </div>

        <!-- Palette Editor -->
        <div class="card">
            <h2 class="collapsible" onclick="toggleSection('paletteSection')">Palette Editor (Optional)</h2>
            <div id="paletteSection" class="collapsible-content collapsed">
                <p>Customize the TMS9918A color palette. Color 0 (transparent) is always black.</p>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="palettePreset">Palette Preset</label>
                    <select id="palettePreset" name="palettePreset" onchange="applyPalettePreset()">
                        <option value="tms9918a" selected>TMS9918A (Default)</option>
                        <option value="v9938">V9938</option>
                        <option value="grey">Greyscale</option>
                        <option value="sepia">Sepia</option>
                    </select>
                </div>

                <div class="palette-grid" id="paletteGrid"></div>
            </div>
        </div>

        <!-- Diagnostic Modes -->
        <div class="card">
            <h2 class="collapsible" onclick="toggleSection('diagSection')">Diagnostic Modes (Optional)</h2>
            <div id="diagSection" class="collapsible-content collapsed">
                <div class="warning-box">
                    <strong>Warning:</strong> Diagnostic modes are for debugging purposes and may affect performance.
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <div class="checkbox-option">
                            <input type="checkbox" id="diagRegisters" name="diagRegisters">
                            <label for="diagRegisters">Show Registers</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" id="diagPerformance" name="diagPerformance">
                            <label for="diagPerformance">Show Performance</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" id="diagPalette" name="diagPalette">
                            <label for="diagPalette">Show Palette Info</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" id="diagAddress" name="diagAddress">
                            <label for="diagAddress">Show Address Info</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration Summary -->
        <div class="card">
            <h2>Configuration Summary</h2>
            <div class="summary" id="configSummary"></div>
        </div>
    </div>

    <!-- Sticky Footer with Action Buttons -->
    <div class="sticky-footer">
        <div class="footer-content">
            <button type="button" class="btn-primary" onclick="generateAndDownload()">Generate & Download UF2</button>
            <button type="button" class="btn-secondary" onclick="resetToDefaults()">Reset to Defaults</button>
        </div>
    </div>

    <script>
        // Constants from config.h
        const CONFIG_BYTES = 256;
        const CONFIG_FLASH_OFFSET = 0x1FF000;
        const XIP_BASE = 0x10000000;
        const CONFIG_FLASH_ADDR = XIP_BASE + CONFIG_FLASH_OFFSET;

        // Configuration byte offsets
        const CONF_PICO_MODEL = 0;
        const CONF_HW_VERSION = 1;
        const CONF_SW_VERSION = 2;
        const CONF_SW_PATCH_VERSION = 3;
        const CONF_CLOCK_TESTED = 4;
        const CONF_DISP_DRIVER = 5;
        const CONF_FLASH_STATUS = 6;
        const CONF_CRT_SCANLINES = 8;
        const CONF_SCANLINE_SPRITES = 9;
        const CONF_CLOCK_PRESET_ID = 10;
        const CONF_DIAG = 16;
        const CONF_DIAG_REGISTERS = 17;
        const CONF_DIAG_PERFORMANCE = 18;
        const CONF_DIAG_PALETTE = 19;
        const CONF_DIAG_ADDRESS = 20;
        const CONF_PALETTE_IDX_0 = 128;

        // UF2 constants
        const UF2_MAGIC_START0 = 0x0A324655;
        const UF2_MAGIC_START1 = 0x9E5D5157;
        const UF2_MAGIC_END = 0x0AB16F30;
        const UF2_FLAG_FAMILYID = 0x00002000;

        // Family IDs and models
        const FAMILY_ID_RP2040 = 0xe48bff56;
        const FAMILY_ID_RP2350 = 0xe48bff59;
        const PICO_MODEL_RP2040 = 1;
        const PICO_MODEL_RP2350 = 2;

        // Display drivers
        const DISP_DRIVER_VGA = 0;
        const DISP_DRIVER_NTSC = 1;
        const DISP_DRIVER_PAL = 2;

        // TMS9918A palette (0xARGB format)
        const PALETTE_TMS9918A = [
            0x0000, 0xF000, 0xF2C3, 0xF5D6, 0xF54F, 0xF76F, 0xFD54, 0xF4EF,
            0xFF54, 0xFF76, 0xFDC3, 0xFED6, 0xF2B2, 0xFC5C, 0xFCCC, 0xFFFF
        ];

        // V9938 palette
        const PALETTE_V9938 = [
            0x0000, 0xF000, 0xF2C2, 0xF6E6, 0xF22E, 0xF46E, 0xFA22, 0xF4CE,
            0xFE22, 0xFE66, 0xFCC2, 0xFCC8, 0xF282, 0xFC4A, 0xFAAA, 0xFEEE
        ];

        // Greyscale palette
        const PALETTE_GREY = [
            0x0000, 0xF000, 0xF666, 0xF888, 0xF888, 0xF999, 0xF777, 0xFBBB,
            0xF888, 0xF999, 0xF999, 0xFBBB, 0xF555, 0xFAAA, 0xFCCC, 0xFFFF
        ];

        // Sepia palette (warm brown tones)
        const PALETTE_SEPIA = [
            0x0000, 0xF000, 0xF643, 0xF865, 0xF865, 0xF976, 0xF754, 0xFBA9,
            0xF865, 0xF976, 0xF976, 0xFBA9, 0xF532, 0xFA97, 0xFCB9, 0xFFED
        ];

        // All available palettes
        const PALETTES = {
            'tms9918a': { name: 'TMS9918A (Default)', colors: PALETTE_TMS9918A },
            'v9938': { name: 'V9938', colors: PALETTE_V9938 },
            'grey': { name: 'Greyscale', colors: PALETTE_GREY },
            'sepia': { name: 'Sepia', colors: PALETTE_SEPIA }
        };

        // Current palette (working copy)
        let currentPalette = [...PALETTE_TMS9918A];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializePaletteEditor();
            updateSummary();

            // Add event listeners for live updates
            document.querySelectorAll('input, select').forEach(element => {
                element.addEventListener('change', updateSummary);
            });
        });

        // Initialize palette editor
        function initializePaletteEditor() {
            const grid = document.getElementById('paletteGrid');
            grid.innerHTML = '';

            for (let i = 0; i < 16; i++) {
                const item = document.createElement('div');
                item.className = 'color-picker-item' + (i === 0 ? ' disabled' : '');

                const label = document.createElement('label');
                label.textContent = `${i}`;
                label.htmlFor = `color${i}`;

                const input = document.createElement('input');
                input.type = 'color';
                input.id = `color${i}`;
                input.value = rgb12ToHex(currentPalette[i]);
                input.disabled = i === 0; // Color 0 is always black
                input.title = i === 0 ? 'Transparent (always black)' : `Color ${i}`;

                const valueSpan = document.createElement('div');
                valueSpan.className = 'color-value';
                valueSpan.id = `value${i}`;
                valueSpan.textContent = formatRgb12(currentPalette[i]);

                if (i !== 0) {
                    input.addEventListener('input', function() {
                        // Convert to 4-bit and back to ensure proper rounding
                        const rgb12 = hexToRgb12(this.value);
                        currentPalette[i] = rgb12;

                        // Update the color picker to show the rounded value
                        this.value = rgb12ToHex(rgb12);

                        // Update the RGB value display
                        document.getElementById(`value${i}`).textContent = formatRgb12(rgb12);

                        updateSummary();
                    });
                }

                item.appendChild(label);
                item.appendChild(input);
                item.appendChild(valueSpan);
                grid.appendChild(item);
            }
        }

        // Toggle collapsible sections
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const header = section.previousElementSibling;
            section.classList.toggle('collapsed');
            header.classList.toggle('collapsed');
        }

        // Apply selected palette preset
        function applyPalettePreset() {
            const presetId = document.getElementById('palettePreset').value;
            const palette = PALETTES[presetId].colors;
            currentPalette = [...palette];

            // Update all color pickers to reflect the new palette
            for (let i = 1; i < 16; i++) {
                document.getElementById(`color${i}`).value = rgb12ToHex(currentPalette[i]);
                document.getElementById(`value${i}`).textContent = formatRgb12(currentPalette[i]);
            }
            updateSummary();
        }

        // Format RGB12 for display
        function formatRgb12(rgb12) {
            const r = (rgb12 >> 8) & 0x0F;
            const g = (rgb12 >> 4) & 0x0F;
            const b = rgb12 & 0x0F;
            return `${r.toString(16).toUpperCase()}${g.toString(16).toUpperCase()}${b.toString(16).toUpperCase()}`;
        }

        // Reset all settings to defaults
        function resetToDefaults() {
            document.getElementById('scanlines').checked = false;
            document.getElementById('scanlineSprites').value = '0';
            document.getElementById('clockPreset').value = '0';
            document.getElementById('diagRegisters').checked = false;
            document.getElementById('diagPerformance').checked = false;
            document.getElementById('diagPalette').checked = false;
            document.getElementById('diagAddress').checked = false;
            document.getElementById('palettePreset').value = 'tms9918a';
            applyPalettePreset();
        }

        // Convert 0xARGB to #RRGGBB
        function rgb12ToHex(rgb12) {
            const r = ((rgb12 >> 8) & 0x0F) * 17;
            const g = ((rgb12 >> 4) & 0x0F) * 17;
            const b = (rgb12 & 0x0F) * 17;
            return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
        }

        // Convert #RRGGBB to 0xFRGB
        function hexToRgb12(hex) {
            const r = parseInt(hex.substr(1, 2), 16);
            const g = parseInt(hex.substr(3, 2), 16);
            const b = parseInt(hex.substr(5, 2), 16);
            return 0xF000 | ((Math.round(r / 17) & 0x0F) << 8) |
                            ((Math.round(g / 17) & 0x0F) << 4) |
                             (Math.round(b / 17) & 0x0F);
        }

        // Format RGB12 for display
        function formatRgb12(rgb12) {
            return '0x' + rgb12.toString(16).toUpperCase().padStart(4, '0');
        }

        // Get current configuration from form
        function getCurrentConfig() {
            // Use defaults: RP2040 and VGA
            // These will be auto-detected by the firmware
            return {
                rp2350: false,  // Default to RP2040
                dispDriver: 0,  // Default to VGA
                scanlines: document.getElementById('scanlines').checked,
                scanlineSprites: parseInt(document.getElementById('scanlineSprites').value),
                clockPreset: parseInt(document.getElementById('clockPreset').value),
                diagRegisters: document.getElementById('diagRegisters').checked,
                diagPerformance: document.getElementById('diagPerformance').checked,
                diagPalette: document.getElementById('diagPalette').checked,
                diagAddress: document.getElementById('diagAddress').checked,
                customPalette: currentPalette
            };
        }

        // Update configuration summary
        function updateSummary() {
            const config = getCurrentConfig();
            const summary = document.getElementById('configSummary');

            const spriteNames = ['4 sprites', '8 sprites', '16 sprites', '32 sprites'];
            const spriteName = spriteNames[config.scanlineSprites];

            const clockNames = ['252.0 MHz', '302.4 MHz', '352.0 MHz'];
            const clockName = clockNames[config.clockPreset];

            const diagnostics = [
                config.diagRegisters && 'Registers',
                config.diagPerformance && 'Performance',
                config.diagPalette && 'Palette',
                config.diagAddress && 'Address'
            ].filter(Boolean);

            const diagText = diagnostics.length > 0 ? diagnostics.join(', ') : 'None';

            // Determine palette status
            const selectedPreset = document.getElementById('palettePreset').value;
            const selectedPalette = PALETTES[selectedPreset].colors;
            const paletteMatches = currentPalette.every((color, i) => color === selectedPalette[i]);
            const paletteText = paletteMatches ? PALETTES[selectedPreset].name : 'Custom';

            summary.innerHTML = `
                <div class="summary-item">
                    <span class="summary-label">CRT Scanlines:</span>
                    <span class="summary-value">${config.scanlines ? 'ON' : 'OFF'}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Scanline Sprites:</span>
                    <span class="summary-value">${spriteName}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Clock Frequency:</span>
                    <span class="summary-value">${clockName}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Diagnostics:</span>
                    <span class="summary-value">${diagText}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Palette:</span>
                    <span class="summary-value">${paletteText}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">File Size:</span>
                    <span class="summary-value">512 bytes</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Target Address:</span>
                    <span class="summary-value">0x${CONFIG_FLASH_ADDR.toString(16).toUpperCase()}</span>
                </div>
            `;
        }

        // Create configuration array
        function createConfigArray(options) {
            const config = new Uint8Array(CONFIG_BYTES);

            // Set hardware fields for validation
            config[CONF_PICO_MODEL] = options.rp2350 ? PICO_MODEL_RP2350 : PICO_MODEL_RP2040;
            config[CONF_DISP_DRIVER] = options.dispDriver;

            // Set user-configurable options
            config[CONF_CRT_SCANLINES] = options.scanlines ? 1 : 0;
            config[CONF_SCANLINE_SPRITES] = options.scanlineSprites & 0x03;
            config[CONF_CLOCK_PRESET_ID] = options.clockPreset & 0x03;

            // Set diagnostic options
            config[CONF_DIAG_REGISTERS] = options.diagRegisters ? 1 : 0;
            config[CONF_DIAG_PERFORMANCE] = options.diagPerformance ? 1 : 0;
            config[CONF_DIAG_PALETTE] = options.diagPalette ? 1 : 0;
            config[CONF_DIAG_ADDRESS] = options.diagAddress ? 1 : 0;

            // Set main DIAG flag if any diagnostic is enabled
            config[CONF_DIAG] = (config[CONF_DIAG_REGISTERS] ||
                                config[CONF_DIAG_PERFORMANCE] ||
                                config[CONF_DIAG_PALETTE] ||
                                config[CONF_DIAG_ADDRESS]) ? 1 : 0;

            // Set palette (color 0 always black)
            config[CONF_PALETTE_IDX_0] = 0x00;
            config[CONF_PALETTE_IDX_0 + 1] = 0x00;

            // Colors 1-15 from custom palette
            const palette = options.customPalette || PALETTE_TMS9918A;
            for (let i = 1; i < 16; i++) {
                const rgb = palette[i];
                config[CONF_PALETTE_IDX_0 + (i * 2)] = (rgb >> 8) & 0xFF;
                config[CONF_PALETTE_IDX_0 + (i * 2) + 1] = rgb & 0xFF;
            }

            return config;
        }

        // Create UF2 block
        function createUF2Block(configData, familyId) {
            const block = new Uint8Array(512);
            const view = new DataView(block.buffer);

            // UF2 header (32 bytes) - all little-endian
            view.setUint32(0, UF2_MAGIC_START0, true);
            view.setUint32(4, UF2_MAGIC_START1, true);
            view.setUint32(8, UF2_FLAG_FAMILYID, true);
            view.setUint32(12, CONFIG_FLASH_ADDR, true);
            view.setUint32(16, CONFIG_BYTES, true);
            view.setUint32(20, 0, true);
            view.setUint32(24, 1, true);
            view.setUint32(28, familyId, true);

            // Copy config data payload
            block.set(configData, 32);

            // Magic end
            view.setUint32(508, UF2_MAGIC_END, true);

            return block;
        }

        // Generate UF2 file
        function generateUF2(options) {
            const config = createConfigArray(options);
            const familyId = options.rp2350 ? FAMILY_ID_RP2350 : FAMILY_ID_RP2040;
            return createUF2Block(config, familyId);
        }

        // Download UF2 file
        function downloadUF2(data, filename) {
            const blob = new Blob([data], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Generate and download configuration
        function generateAndDownload() {
            const config = getCurrentConfig();

            // Simple filename - hardware is auto-detected by firmware
            const filename = `pico9918_config.uf2`;

            try {
                const uf2Data = generateUF2(config);
                downloadUF2(uf2Data, filename);

                // Show success feedback
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '✓ Downloaded!';
                btn.style.background = 'var(--success-color)';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            } catch (error) {
                alert('Error generating UF2 file: ' + error.message);
                console.error(error);
            }
        }
    </script>
</body>
</html>
